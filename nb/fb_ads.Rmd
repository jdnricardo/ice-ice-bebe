---
title: "ProPublica Facebook Ad Collector"
output:
  html_document:
    df_print: paged
    toc: yes
  html_notebook:
    toc: yes
    toc_float: yes
date: 'Last updated: `r Sys.Date()`'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library(magrittr)
library(data.table)
library(dplyr)
library(lubridate)
library(tidyr)
library(purrr)
library(xray)
library(feather)
library(ggplot2)
library(scales)
library(htmlwidgets)
library(ochRe)
library(dutchmasters)
set.seed(2018)
```

At the moment, loading either format of the FB dataset first requires downloading the csv from ProPublica to the directory `/inst/extdata/csv` before sourcing the `load_propub_fb.R` script,

```{r source_script}
source("../inst/load_propub_fb.R")

theme_set(theme_grey() + 
            theme(panel.background = element_rect(fil = dutchmasters$milkmaid[[7]]),
                  panel.grid = element_blank(),
                  panel.grid.major.y = element_line(colour = dutchmasters$milkmaid[[6]])))
```

```{r data_load}
load_from <- "feather" # "csv"

if (load_from == "feather") {
  ads_list <- ads_feather()
  
  ads_sample <- data.table(ads_list$ads)
  ad_targs_sample <- data.table(ads_list$ad_targs)
  
  rm(ads_list)
  
} else if (load_from == "csv") {
  ads_sample <- list.files("../inst/extdata/csv",
                           pattern = basename(ads_file_nm),
                           full.names = TRUE) %>% 
    fread() %>% 
    data.table()
}
```

```{r sample_ad_db}
ads_sample <- ads_sample[created_at >= ymd("2017-10-01"), wk :=  round_date(created_at, "1 week")][!is.na(wk)]
ad_targs_sample <- ad_targs_sample[id %in% unique(ads_sample$id)]
```

## First-pass data summary

Looking at the volume of ads over time, ignoring all other variables. Such general increase, with surprising lull over 2017 holiday period and sharp drop in April 2018.

```{r ad_vol_basic, fig.asp=0.5}
ads_sample[, .N, by = wk] %>% 
  ggplot(aes(wk, N)) +
  geom_line(colour = dutchmasters$milkmaid[[10]],
            size = 1.2) +
  geom_smooth(method = "loess",
              colour = dutchmasters$milkmaid[[1]],
              size = 1.1, alpha = 1/3) +
  scale_x_datetime(date_breaks = "2 months", date_labels = "%b %Y") +
  scale_y_continuous(breaks = pretty_breaks(4)) +
  labs(x = NULL, y = "# of Ads",
       title = "Weekly Ad Volume")
```

Looking at the impressions over time, ignoring all other variables. Such general stability after heavy period in last quarter of 2017. Similar dips as previous graph during 2017 holiday period and April 2018.

```{r impressions_vol_basic, fig.asp=0.56}
ads_sample[,  .(impressions=sum(as.numeric(impressions))), by = wk] %>% 
  ggplot(aes(wk, impressions)) +
  geom_line(colour = dutchmasters$milkmaid[[10]],
            size = 1.2) +
  geom_smooth(method = "loess",
              colour = dutchmasters$milkmaid[[1]],
              size = 1.1, alpha = 1/5) +
  scale_x_datetime(date_breaks = "2 months", date_labels = "%b %Y") +
  scale_y_log10(breaks = c(1e1,1e2,1e3,1e4)) +
  annotation_logticks(sides = "l", 
                      colour = dutchmasters$milkmaid[[6]]) +
  labs(x = NULL, y = "# of Impressions",
       title = "Weekly Impression Volume",
       subtitle = "log scale",
       caption = "Source: ProPublica Facebook Political Ad Collector")
```

And we can look at the weekly distribution of political ratings rated as "political" based on the ProPublica classifier (probability of 70% or more).

```{r political_frac}
ads_sample[, .(median=median(political_probability),
               qnt05=quantile(political_probability,0.05),
               qnt25=quantile(political_probability,0.25),
               qnt75=quantile(political_probability,0.75),
               qnt95=quantile(political_probability,0.95)), by = wk] %>% 
  ggplot(aes(wk)) +
  geom_ribbon(aes(ymin = qnt05, ymax = qnt95),
              fill = dutchmasters$milkmaid[[10]],
              alpha = 1/3) +
  geom_ribbon(aes(ymin = qnt25, ymax = qnt75),
              fill = dutchmasters$milkmaid[[10]],
              alpha = 1/2) +
  geom_line(aes(y = median),
            size = 1.1,
            colour = dutchmasters$milkmaid[[1]]) +
  scale_x_datetime(date_breaks = "2 months", date_labels = "%b %Y",
                   expand = c(0,0)) +
  scale_y_continuous(labels = percent, expand = c(0.025,0)) +
  coord_cartesian(ylim = c(0.7,1)) +
  labs(x = NULL, y = NULL,
       title = "Weekly Median Political Probability of Ads",
       subtitle = "as classified by ProPublica Facebook Ad Collector",
       caption = paste0("*dataset excludes ads with probability < 70%",
                        "; ribbons show 5th, 25th, 75th, and 95th percentile"))
```

## Feature generation

Beginning work to tease out features in dataset

- Weekly impressions per ad over time

Looks like someone at Facebook or ProPublica changed something in an algorithm in Dec 2017?

```{r}
ads_sample[, .(impresh_by_vol = sum(impressions)/.N), by = wk] %>% 
  ggplot(aes(wk, impresh_by_vol)) +
  geom_line(colour = dutchmasters$milkmaid[[10]],
            size = 1.2) +
  geom_smooth(method = "loess",
              colour = dutchmasters$milkmaid[[1]],
              size = 1.1, alpha = 1/5) +
  scale_x_datetime(date_breaks = "2 months", date_labels = "%b %Y") +
  scale_y_sqrt(breaks = c(1,2,5,10,20,50,100)) +
  labs(x = NULL, y = "Impressions per Ad",
       title = "Weekly Impressions per Ad",
       subtitle = "log scale",
       caption = "Source: ProPublica Facebook Political Ad Collector")
```

## Ad targeting

Beginning work to unpack ad targets. Can now access as separate dataset, which can be merged with main dataset to compare targeting labels with other variables.

```{r ad_targets, fig.height = 2, fig.width = 6}
ad_targs_sample[, .N, by = grepl("United States", target)] %>% 
  rename(mentions_usa = grepl) %>% 
  ggplot(aes(1, N, fill = mentions_usa)) +
  geom_bar(stat = "identity", position = "stack") +
  geom_text(aes(label = percent(round(N/sum(N),2))),
            position = position_stack(vjust = 0.5),
            colour = "white", fontface = "bold", size = rel(5)) +
  coord_flip() +
  scale_fill_dutchmasters(palette = "milkmaid") +
  guides(fill = guide_legend(reverse = TRUE)) +
  labs(x = NULL, y = NULL, fill = NULL,
       title = "Proportion of Ads Targeting `United States`",
       caption = "Source: ProPublica Facebook Political Ad Collector") +
  theme_void() +
  theme(legend.position = "bottom",
        legend.justification = "center")
```

## Future work

- Highlighting weekly summary with notable events (i.e. special elections, particular ad buyers)
- Relationship between political probability and ad / impression volume
- Targets, advertisers, paid for by (and their relationships in time, with probability/vol/etc)

## In the weeds...

#### Numeric columns

```{r dists}
quiet_dist <- quietly(function(.x) distributions(.x, charts = FALSE))

ads_sample %>% 
  select_if(is.numeric) %>% 
  quiet_dist() %$% 
  DT::datatable(result, options = list(dom = "ft"))
```

#### Anomalies

```{r anomalies}
anomalies(ads_sample, 0.85, 1)[["variables"]] %>% 
  DT::datatable(extensions = c("Buttons", "Responsive"),
                options = list(dom = "Bft", buttons = I("colvis")))
```